---
title: "Gears Experiment"
author: "Lisa Ko√ümann"
date: "13 Dezember 2019"
output: html_document
---
```{r}
install.packages("brms")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(brms)
library(dplyr)
library(fs)
library(forcats)
library(ggbeeswarm)
library(ggplot2)
library(readr)
library(tibble)
```

```{r Tabula rasa}
rm(list=ls())
```


## Importing data
```{r Import}
reports <- 
  # 1. Figure out which files need to be loaded
  tibble(filename = as.character(dir_ls(path = "Data", glob  = "*gears*.csv"))) %>%
  
  # 2. Load files on by one (hence rowwise())
  rowwise() %>%
  do(read_csv(.$filename[1], 
              col_types = cols(Participant = col_character(),
                               Session = col_character(),
                               Block = col_integer(),
                               OnsetDelay = col_double(),
                               Condition = col_character(),
                               Distance = col_double(),
                               DisplayLeft = col_character(),
                               DisplayRight = col_character(),
                               Occlusion = col_character(),
                               Percept = col_character(),
                               Time = col_double()))) %>%
  ungroup() %>%
  
  # 3. Compute duration PER BLOCK. Inside mutate use "lead(Time)".
  group_by(Participant, Block) %>%
  mutate(Duration = lead(Time) - Time) %>%
  ungroup() %>%
  
  # 4. Drop "end" Percept
  filter(Percept != "end") %>%
  
  # 5. Figuring out OTHER gear display. "gear24" for fully ambiguous, other image for disambiguated cases.
  #    Logic: if DisplayLeft == "gear24" then it is "DisplayRight" else it is DisplayLeft.
  mutate(Display = ifelse(DisplayLeft=="gear24", DisplayRight, DisplayLeft))%>% #turn into factor
  # 6. Convert Occlusion into numeric. First, change "None" to "0" via stringr::str_replace_all(Occlusion, "None", "0").
  #    Then, convert it to numeric in mutate.
  mutate(OccluderWidth= as.numeric(ifelse(Occlusion=="None", "0", Occlusion)))%>%
  # 7. Renaming Displays
  mutate(Percept=as.factor(Percept),
         Percept=fct_recode(Percept, "Counterrotation"="up", "Counterrotation"="down", "Corotation"="left", "Corotation"="right"), DisplayLeft=fct_recode(DisplayLeft, "weak"="gear24-strong", "medium"="gear24-medium-strong", "strong"="gear24-weak", "full"= "gear24"), 
         DisplayRight=fct_recode(DisplayRight, "weak"="gear24-strong", "medium"="gear24-medium-strong", "strong"="gear24-weak", "full"= "gear24"))
```
##Distance Condition

```{r}
#Computing Distance Duration
distance<- reports%>%
  filter(Condition=="Control"|Condition=="Separation")%>% 
  filter(Percept!="unclear")%>%
# each participant and Distance seperatly
    group_by(Participant, Distance)%>% 
  summarize(TotalDuration=sum(Duration),
#if value in the brackets is true itll be considered if not it will not
  CorotateDur=sum(Duration[Percept=="Corotation"]),
  Pcorotation=CorotateDur/TotalDuration)%>%
  mutate(PCorotationAdj=Pcorotation*0.999+0.0005)%>%
  #changing distance to factor
  mutate(Distance=as.factor(Distance),
         Distance=fct_relevel(Distance,"-8.13", "0", "8.13", "32.25", "65.04"))
#Plotting Distance
ggplot(data=distance, aes(x=Distance, group=Distance, y=Pcorotation, color=Participant))+ ## the mistake is caused by mutating distance colum but how do I fix it?
  geom_boxplot(outlier.shape = NA)+ 
  geom_point()+
  geom_beeswarm() + 
  geom_quasirandom()+ 
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70)) + 
  theme(legend.position = "none")

```

```{r}
distancefit<- brm(PCorotationAdj ~ Distance + (1|Participant), family=Beta(), data=distance, 
    prior=c(prior(normal(0,10),class="b", coef=Distance)))
```

```{r}
plot(distancefit)
```
##Occlusion Condition
```{r}
#Computing Occlusion Duration
occlusion<- reports%>%
  filter(Condition=="Control"|Condition=="Occlusion") %>%
  filter(Percept!="unclear") %>%
  
  # reorder Occlusion to factor
  # 1. Display to factor
  mutate(Display=as.factor(Display),
         Occlusion=as.factor(Occlusion),
         Occlusion=fct_recode(Occlusion, "0"="None", "8.13"="8.13", "16.26"="16.26", "32.52"="32.52","65.04"="65.04"),
         fct_relevel(Occlusion, "0","8.13", "16.26", "32.52", "65.04"))%>%
  # 2. Use fct_relevel function, which goes Var = fct_relevel(Var, "first level", "second level", ...)
  
  # each participant and Occlusion seperatly
  group_by(Participant, Occlusion)%>% 
  summarize(TotalDuration=sum(Duration),

  #if value in the brackets is true itll be considered if not it will not
  CorotateDur=sum(Duration[Percept=="Corotation"]),
  Pcorotation=CorotateDur/TotalDuration)%>%
  mutate(PCorotationAdj=Pcorotation*0.999+0.0005)

#Plotting Occlusion
ggplot(data=occlusion, aes(x=Occlusion, group=Occlusion, y=Pcorotation, color=Participant))+
  geom_boxplot(outlier.shape = NA)+
  geom_point()+
  geom_beeswarm()+
  geom_quasirandom()+
   scale_x_continuous(breaks = c(0, 10, 20)) + 
  theme(legend.position = "none")
```

```{r}
# Computing brm for Occlusion condition
Oc<- brm(PCorotationAdj ~ Occlusion + (1|Participant), family=Beta(), data=occlusion, 
    prior=c(prior(normal(0,10),class="b", coef=Occlusion)))
```

## Ambiguity Condition
```{r}
#Computing Ambiguity Duration
ambiguity<- reports%>%
  filter(Condition=="Control"|Condition=="Ambiguity")%>% 
  filter(Percept!="unclear")%>%
  
  # 1. Display to factor
  # 2. Rename levels using fct_recode
  # 3. Reorder Display
  
  # each participant and Ambiguity seperatly
  group_by(Participant, Display)%>% 
  summarize(TotalDuration=sum(Duration),
  
  # if value in the brackets is true itll be considered if not it will not
  CorotateDur=sum(Duration[Percept=="Corotation"]),
  Pcorotation=CorotateDur/TotalDuration)


#Plotting Ambiguity
ggplot(data=ambiguity, aes(x=Display, group=Display, y=Pcorotation) )+
  geom_boxplot()+
  geom_point()

```

