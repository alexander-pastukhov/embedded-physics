---
title: "Gears Experiment"
author: "Lisa Ko√ümann"
date: "13 Dezember 2019"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(brms)
library(dplyr)
library(fs)
library(forcats)
library(ggbeeswarm)
library(glue)
library(ggplot2)
library(grid)
library(plyr)
library(readr)
library(stringr)
library(tibble)
library(tidyr)
```

```{r Tabula rasa}
rm(list=ls())
```


## Importing data
```{r Import}
reports <- 
  # 1. Figure out which files need to be loaded
  tibble(filename = as.character(dir_ls(path = "Data", glob  = "*gears*.csv"))) %>%
  
  # 2. Load files on by one (hence rowwise())
  rowwise() %>%
  do(read_csv(.$filename[1], 
              col_types = cols(Participant = col_character(),
                               Session = col_character(),
                               Block = col_integer(),
                               OnsetDelay = col_double(),
                               Condition = col_character(),
                               Distance = col_double(),
                               DisplayLeft = col_character(),
                               DisplayRight = col_character(),
                               Occlusion = col_character(),
                               Percept = col_character(),
                               Time = col_double()))) %>%
  ungroup() %>%
  
  # 3. Compute duration PER BLOCK. Inside mutate use "lead(Time)".
  group_by(Participant, Block) %>%
  mutate(Duration = lead(Time) - Time) %>%
  ungroup() %>%
  
  # 4. Drop "end" Percept
  filter(Percept != "end") %>%
  
  # 5. Renaming Displays
  mutate(Percept=as.factor(Percept),
         Percept=fct_recode(Percept, "Counterrotation"="up", "Counterrotation"="down", "Corotation"="left", "Corotation"="right"),
         DisplayLeft=as.factor(DisplayLeft),
         DisplayLeft = fct_recode(DisplayLeft, "strong"="gear24-strong",
                                               "medium"= "gear24-medium",
                                               "medium-strong"="gear24-medium-strong",
                                               "weak"="gear24-weak",
                                               "ambiguous"= "gear24"),
         DisplayLeft = fct_relevel(DisplayLeft, "ambiguous", "weak", "medium", "medium-strong", "strong" ),
         DisplayRight=as.factor(DisplayRight),
         DisplayRight=fct_recode(DisplayRight, "strong"="gear24-strong",
                                               "medium-strong"="gear24-medium-strong",
                                               "medium"="gear24-medium",
                                               "weak"="gear24-weak",
                                               "ambiguous"= "gear24"),
        DisplayRight=fct_relevel(DisplayRight, "ambiguous", "weak", "medium", "medium-strong", "strong")) %>%

  
  # 5. Figuring out OTHER gear display. "gear24" for fully ambiguous, other image for disambiguated cases.
  #    Logic: if DisplayLeft == "gear24" then it is "DisplayRight" else it is DisplayLeft.
   mutate(Display = ifelse(DisplayLeft=="ambiguous", as.character(DisplayRight), as.character(DisplayLeft)),
          Display=as.factor(Display),
          Display=fct_relevel(Display,"ambiguous", "weak", "medium", "medium-strong", "strong")) %>% 
  
  # 6. Convert Occlusion into numeric. First, change "None" to "0" via stringr::str_replace_all(Occlusion, "None", "0").
  #    Then, convert it to numeric in mutate.
  mutate(OccluderWidth= as.numeric(ifelse(Occlusion=="None", "0", Occlusion)))

```

## Distance condition

```{r}
#Computing Distance Duration
distance <-
  reports%>%
  filter(Condition=="Control"|Condition=="Separation") %>% 
  filter(Percept!="unclear") %>%

  # distance as factor  
  mutate(DistanceAsFactor=as.factor(Distance),
         DistanceAsFactor=fct_relevel(DistanceAsFactor,"-8.13", "0", "8.13", "32.52", "65.04")) %>%

  # each participant and Distance seperatly
  group_by(Participant, Distance, DistanceAsFactor) %>% 
  summarize(TotalDuration=sum(Duration),
            # if value in the brackets is true itll be considered if not it will not
            CorotateDur=sum(Duration[Percept=="Corotation"]),
            Pcorotation=CorotateDur/TotalDuration) %>%
  mutate(PCorotationAdj=Pcorotation*0.999+0.0005)
  
#Plotting Distance
plot_distance <- ggplot(data=distance,
       aes(x=Distance, group=Distance, y=Pcorotation, color=Participant)) +
  geom_boxplot(outlier.shape = NA) +
  geom_beeswarm() +
  theme(legend.position = "none")
```

```{r Fitting distance as a continuous variable}
# Computing brm for distance condition
set.seed(9578175)
distance_fit <- brm(PCorotationAdj ~ Distance + (1|Participant),
                     family=Beta(),
                     data=distance,
                     prior=c(prior(normal(0,10), class="b")))
```


```{r Plot Distance as continuous predictions}
# predict GROUP-LEVEL Pcorotation
distance_fit_predictions <- predict(distance_fit,
                                     newdata = data.frame(Distance = seq(-10, 70, 1), Participant=NA),
                                     re_formula = ~ (1 | Participant)) %>%
  data.frame() %>%
  add_column(Distance = seq(-10, 70, 1))

plot_distance_fit_predictions<- ggplot(data=distance_fit_predictions, 
      aes(x = Distance, y=Estimate)) + 
  geom_ribbon(aes(ymin=Q2.5, ymax=Q97.5), alpha= 0.25) + 
  geom_line() + 
  geom_beeswarm(data=distance, 
                aes(x=Distance, group=Distance, y=Pcorotation, color=Participant)) + 
  theme(legend.position = "none") + 
  ylim(0, 1)
```

```{r Plotting Distance Beta}
posterior_samples(distance_fit)%>%
  select(b_Distance)%>%
  
 plot_posterior_samples_distance_beta <- ggplot(aes(x=b_Distance)) +
  geom_histogram()
```

## Distance as factor
```{r fitting distance as factor}
set.seed(9847899)
distance_as_factor_fit <- brm(PCorotationAdj ~ DistanceAsFactor + (1|Participant),
                              family=Beta(), 
                              data=distance,
                              prior=c(prior(normal(0,10), class="b")))
```

```{r plotting pairwise comparisons for the individual levels of Distance}
samples_distance_as_factor_fit <- posterior_samples(distance_as_factor_fit)

distance_levels <- 
  samples_distance_as_factor_fit%>%
  
  # only retain distacn levels
  select(starts_with("b_Distance")) %>%
  
  # wide to long
  pivot_longer(cols=everything(), names_to = "Distance", values_to = "Beta") %>%

  # turn distance name into a factor
  mutate(Distance = str_remove_all(Distance, "b_DistanceAsFactor"), 
         Distance = as.factor(Distance),
         Distance = fct_relevel(Distance, "-8.13", "0", "8.13", "32.52", "65.04"))
          
plot_distance_pairwise_comparison<- ggplot(data=distance_levels, 
       aes(x = Beta, fill=Distance)) + 
  geom_histogram(alpha=0.5, position="identity", bins=100)
```

```{r Number of values above zero}
distance_levels%>%
  group_by(Distance, Beta)%>%
  summarize(numAbove=sum(Beta > 0))%>%
  mutate(TotalBeta=nrow(distance_levels),
         Pbetaabove=numAbove/TotalBeta)
```
```{r computing no of values above zero for each condition}
distance_levels%>%
  select(Distance=="8.13")%>%
  summarize(numAbove=sum(Beta > 0))%>%
  mutate(TotalBeta=nrow(distance_levels),
         Pbetaabove=numAbove/TotalBeta)
```


```{r combining the plots for distance condition}
pushViewport(viewport(layout= grid.layout(2,2)))
print(plot_distance, vp= viewpoint(layout.pos.row= 1, layoutt.pos.col= 1))
print(plot_distance_fit_predictions, vp= viewpoint(layout.pos.row= 1, layout.pos.col= 2))
print(plot_distance_pairwise_comparison, vp= viewpoint(layout.pos.row =2, layout.pos.col= 1))
print(plot_posterior_samples_distance_beta, vp= viewpoint(layout.pos.row =2, layout.pos.col= 2))
## I know this is not what you meant but I failed at combining them otherwise


```


## Occlusion Condition
```{r}
#Computing Occlusion Duration
occlusion<- reports%>%
  filter(Condition=="Control"|Condition=="Occlusion") %>%
  filter(Percept!="unclear") %>%
  
  # replace "None" with "0" and then turn Occlusion to a numeric variable
  mutate(Occlusion = ifelse(Occlusion == "None", "0", Occlusion), 
         Occlusion = as.numeric(Occlusion)) %>%
  
  # reorder Occlusion to factor
  # 1. Display to factor
  mutate(Display=as.factor(Display),
         OcclusionAsFactor=as.factor(Occlusion),
         OcclusionAsFactor=fct_relevel(OcclusionAsFactor, "0","8.13", "16.26", "32.52", "65.04")) %>%
  
  # 2. Use fct_relevel function, which goes Var = fct_relevel(Var, "first level", "second level", ...)
  # each participant and Occlusion seperatly
  group_by(Participant, Occlusion, OcclusionAsFactor) %>% 
  summarize(TotalDuration = sum(Duration),
           #if value in the brackets is true itll be considered if not it will not
            CorotateDur = sum(Duration[Percept == "Corotation"]),
            Pcorotation = CorotateDur / TotalDuration)%>%
  
  mutate(PCorotationAdj = Pcorotation*0.999+0.0005)

#Plotting Occlusion
ggplot(data=occlusion, aes(x=Occlusion, group=Occlusion, y=Pcorotation, color=Participant))+
  geom_boxplot(outlier.shape = NA)+
  geom_beeswarm()+
  # geom_quasirandom()+
  theme(legend.position = "none")
```

```{r Fitting occlusion as a continuous variable}
# Computing brm for Occlusion condition
set.seed(9789931)
occlusion_fit <- brm(PCorotationAdj ~ Occlusion + (1|Participant),
                     family=Beta(),
                     data=occlusion,
                     prior=c(prior(normal(0,10), class="b")))
```


```{r Plot occlusions as continuous predictions}
# predict GROUP-LEVEL Pcorotation
occlusion_fit_predictions <- predict(occlusion_fit,
                                     newdata = data.frame(Occlusion = seq(0, 70, 1), Participant=NA),
                                     re_formula = ~ (1 | Participant)) %>%
  data.frame() %>%
  add_column(Occlusion = seq(0, 70, 1))

ggplot(data=occlusion_fit_predictions, 
      aes(x = Occlusion, y=Estimate)) + 
  geom_ribbon(aes(ymin=Q2.5, ymax=Q97.5), alpha= 0.25) + 
  geom_line() + 
  geom_beeswarm(data=occlusion, 
                aes(x=Occlusion, group=Occlusion, y=Pcorotation, color=Participant)) + 
  theme(legend.position = "none") + 
  ylim(0, 1)
```

```{r Plot histogram one beta}
  posterior_samples(occlusion_fit) %>%
  select(b_Occlusion) %>%

  ggplot(aes(x=b_Occlusion))+
           geom_histogram()


```




```{r occlusion as factor fit}
#  Computing brm for Occlusion as factor condition
set.seed(89925355)
occlusion_as_factor_fit <- brm(PCorotationAdj ~ OcclusionAsFactor + (1|Participant),
                               family=Beta(),
                               data=occlusion,
                               prior=c(prior(normal(0,10), class="b")))
```

```{r plotting pairwise comparisons for the individual levels of the occlusion}
samples_occlusion_as_factor_fit <- posterior_samples(occlusion_as_factor_fit)

occlusion_levels <- 
  samples_occlusion_as_factor_fit %>%
  
  # only retain Occlusion levels
  select(starts_with("b_Occlusion")) %>%
  
  # wide to long
  pivot_longer(cols=everything(), names_to = "Occlusion", values_to = "Beta") %>%

  # turn occlusion name into a factor
  mutate(Occlusion = str_remove_all(Occlusion, "b_OcclusionAsFactor"), 
         Occlusion = as.factor(Occlusion),
         Occlusion = fct_relevel(Occlusion, "8.13", "16.26", "32.52", "65.04"))

ggplot(data=occlusion_levels, 
       aes(x = Beta, fill=Occlusion)) + 
  geom_histogram(alpha=0.5, position="identity", bins=100)
```



## Ambiguity Condition
```{r}
#Computing Ambiguity Duration
ambiguity<- reports%>%
  filter(Condition=="Control"|Condition=="Ambiguity")%>% 
  filter(Percept!="unclear")%>%
  
  # 1. Display to factor                 ## isnt this part of preprossessing now?
  # 2. Rename levels using fct_recode
  # 3. Reorder Display
  
  # each participant and Ambiguity seperatly
  group_by(Participant, Display)%>% 
  summarize(TotalDuration=sum(Duration),
  
  # if value in the brackets is true itll be considered if not it will not
  CorotateDur=sum(Duration[Percept=="Corotation"]),
  Pcorotation=CorotateDur/TotalDuration)%>%
  mutate(PCorotationAdj=Pcorotation*0.999+0.0005)



#Plotting Ambiguity
ggplot(data=ambiguity, aes(x=Display, group=Display, y=Pcorotation, color=Participant) )+
  geom_boxplot(outlier.shape = NA)+
  geom_beeswarm()+
  theme(legend.position="none")
  

```

```{r}
set.seed(99435)
ambiguity_brm <- brm(PCorotationAdj ~ Display +(1|Participant),
                                                 family= Beta(),
                                                 data= ambiguity,
                                                 prior=c(prior(normal(0,10), class="b")))
```

```{r}
samples_ambiguity_brm<- sample(ambiguity_brm)
```

```{r}

```

